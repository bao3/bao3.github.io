<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	iOS 8 按需连接 VPN的描述文件 - 
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}
	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
					<div class="profilepic">
						<img src="asset/icon.jpg" style="width:160px;">
					</div>
					<h1><a href="index.html"></a></h1>
					<p class="subtitle"></p>
					<nav id="main-nav">
						<ul class="main">
							<li><a href="index.html">Home</a></li>
						    <!-- <li><a href="all.html">Blog</a></li>-->	
						    <li><a href="archives.html">Archives</a></li>
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">

<!-- 
			<a class="email" href="mailto:" title="Email">Email</a>
			<a class="facebook" href="http://www.facebook.com/" title="Facebook">Facebook</a>
			<a class="google" href="https://plus.google.com/" rel="author" title="Google+">Google+</a>
			<a class="twitter" href="http://twitter.com/" title="Twitter">Twitter</a>
			<a class="github" href="https://github.com/" title="GitHub">GitHub</a>
			<a class="coderwall" href="https://coderwall.com/" title="Coderwall">Coderwall</a>
		    <a class="stackoverflow" href="http://stackoverflow.com/users/" title="StackOverflow"></a>
			<a class="linkedin" href="http://www.linkedin.com/in/" title="LinkedIn">LinkedIn</a>
			<a class="pinterest" href="https://pinterest.com/" title="Pinterest">Pinterest</a>
			<a class="delicious" href="http://delicious.com/" title="Delicious">Delicious</a>
			<a class="pinboard" href="https://pinboard.in/u:" title="Pinboard">Pinboard</a>
			<a class="douban" href="https://www.douban.com/people/" title="Douban">Douban</a>
			<a class="quora" href="https://quora.com/" title="Quora">Quora</a>
			<a class="instagram" href="https://instagram.com/" title="Instagram">Instagram</a>
			<a class="behance" href="https://www.behance.net/" title="Behance">Behance</a>
			<a class="facebook" href="http://www.facebook.com/" title="Facebook">Facebook</a>
								<a class="twitter" href="http://twitter.com/" title="Twitter">Twitter</a>
								<a class="github" href="https://github.com/" title="GitHub">GitHub</a>
-->	
								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">

	<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
		<h1 class="title" itemprop="name">iOS 8 按需连接 VPN的描述文件</h1>
		<div class="entry-content" itemprop="articleBody">
			<p>适合阅读本文的人群：喜欢动手，有困难时可以查阅官方文档的 <strong><em>VPN使用者</em></strong>, 没错，不必是 VPN发行商。</p>

<span id="more"></span><!-- more -->

<p>最近在为<strong>黑帮</strong>制作一个 iPhone一个自动连接的 VPN配置文件，但发现实现起来有各种不爽，于是在网络上搜了一下。应该说全中文网没有好的共享方案，直到看到了<a href="https://maoxian.de/2014/10/setup-ikev2-on-demand-vpn-on-ios-8-and-ikev2-ikev1-cisco-ipsec-vpn-with-strongswan/1220.html">maoxian.de</a> 这篇在 iOS8上实现 VPN按需连接的文章，才算是勉强通用，不过也不尽如人意。原作者的问题在于，VPN为<code>长连接状态</code>而不是真的按需连接。原本是在作者的下面提供了我的一些见解，不过与作者的实战经验有差别，所以没能显示出来。所以我想另写一篇自己的经验分享，希望中文圈可以有自己的定制。</p>

<p>这篇文章是参考了以下几章节：<br/>
+ <a href="https://help.apple.com/deployment/ios/#/iordfafc6ead">IOS 部署参考 - Apple </a><br/>
+ <a href="https://developer.apple.com/library/prerelease/mac/featuredarticles/iPhoneConfigurationProfileRef/Introduction/Introduction.html">Configuration Profile Key Reference -Apple 描述文件键值定义</a><br/>
+ <a href="https://maoxian.de/2014/10/setup-ikev2-on-demand-vpn-on-ios-8-and-ikev2-ikev1-cisco-ipsec-vpn-with-strongswan/1220.html">Setup IKEv2 On Demand VPN on iOS - Maoxian</a><br/>
+ <a href="https://wiki.strongswan.org/projects/strongswan/wiki/AppleIKEv2Profile">IKEv2 Configuration Profile for Apple iOS 8 and newer - Strongswan</a></p>

<hr/>

<p>在接下来的这个文章中我将实现的功能：<br/>
+ WiFi 下自动连接，关屏或者断 WiFi自动断开，目的是为了连接公共 WiFi的安全性<br/>
+ 按域名，自动连接<br/>
+ 长连接，无论何时永远连接 VPN</p>

<p>显然以上三个目标是无法在一个VPN下面达成，不过我们可以多一个心眼 —— 多创建几个同样的 VPN，例如我创建的是<code>IKEv2-WiFi</code> ， <code>IKEv2-Domain</code> ，<code>IKEv2-Alaways</code> ，虽然这在 iOS上会显示成 3个不同的 VPN名字，但其实是同一个 VPN，只是功能不同，适合不同的人群需求。</p>

<h1 id="toc_0">WiFi下自动连接 VPN</h1>

<p>在苹果给出的开发手册上主要能实现的功能是<code>判断 SSID</code> 来决定连接或者不连接，或者所有 WiFi下都连接 VPN，甚至是在 SSID下测试某个 URL能否成功来决定是不是要连接 VPN。对于我们普通人而言，基本是在所有 WiFi下都自动连接最简单。</p>

<p><em>对于越狱并且使用 Shadowsocks的朋友来说</em>，非常推荐使用  <code>在所有 WiFi下都自动连接VPN</code> &gt;</p>

<pre><code>                &lt;!-- Setup WiFi --&gt;
                &lt;key&gt;OnDemandEnabled&lt;/key&gt;
                &lt;integer&gt;1&lt;/integer&gt;
                &lt;key&gt;OnDemandRules&lt;/key&gt;
                &lt;array&gt;
            &lt;!-- 这个故意保留，您可以自定在哪些WiFi不必自动连接或连接
            &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;Disconnect&lt;/string&gt; 
                        &lt;key&gt;InterfaceTypeMatch&lt;/key&gt;
                        &lt;string&gt;WiFi&lt;/string&gt;
                        &lt;key&gt;SSIDMatch&lt;/key&gt;
                        &lt;array&gt;
            --&gt;
                            &lt;string&gt;Coco_baobao-5G&lt;/string&gt;
                        &lt;/array&gt;
          &lt;/dict&gt;
          &lt;!-- 接下来这部分是规定了在 WiFi下自动连接Ikev2 --&gt;
                    &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;Connect&lt;/string&gt;
                        &lt;key&gt;InterfaceTypeMatch&lt;/key&gt;
                        &lt;string&gt;WiFi&lt;/string&gt;
                    &lt;/dict&gt;
          &lt;!-- 下面的 Cellular则是要求手机在3G/4G下不自动 VPN --&gt;
                    &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;Disconnect&lt;/string&gt;
                        &lt;key&gt;InterfaceTypeMatch&lt;/key&gt;
                        &lt;string&gt;Cellular&lt;/string&gt;
                    &lt;/dict&gt;
                &lt;/array&gt;
        &lt;!--以上就是自动 WiFi连接的设定 --&gt;

</code></pre>

<p>是不是觉得很简单？代码中的注释，你可以不用删除，因为导入手机或者 <code>Apple Configurator</code> 之后自动就过滤掉了。<br/>
<strong>那么问题来了，代码要插入到哪里？</strong>其实很简单，根据官方手册，只要插入到 VPN协商配置那一段就可以，这里我以 IKEv2的配置为例，入位置如下：</p>

<pre><code>        &lt;dict&gt; &lt;!-- 请注意这第一个 dict --&gt;
                &lt;key&gt;AuthName&lt;/key&gt;
                &lt;string&gt;ios8&lt;/string&gt;
                &lt;key&gt;AuthPassword&lt;/key&gt;
                &lt;string&gt;Demo@iOS&lt;/string&gt;
                &lt;key&gt;AuthenticationMethod&lt;/key&gt;
                &lt;string&gt;SharedSecret&lt;/string&gt;
                &lt;key&gt;ChildSecurityAssociationParameters&lt;/key&gt;
                &lt;dict&gt;
                    &lt;key&gt;DiffieHellmanGroup&lt;/key&gt;
                    &lt;integer&gt;0&lt;/integer&gt;
                    &lt;key&gt;EncryptionAlgorithm&lt;/key&gt;
                    &lt;string&gt;3DES&lt;/string&gt;
                    &lt;key&gt;IntegrityAlgorithm&lt;/key&gt;
                    &lt;string&gt;SHA1-96&lt;/string&gt;
                    &lt;key&gt;LifeTimeInMinutes&lt;/key&gt;
                    &lt;integer&gt;1440&lt;/integer&gt;
                &lt;/dict&gt;
                &lt;key&gt;DeadPeerDetectionRate&lt;/key&gt;
                &lt;string&gt;Low&lt;/string&gt;
                &lt;key&gt;ExtendedAuthEnabled&lt;/key&gt;
                &lt;true/&gt;
                &lt;key&gt;IKESecurityAssociationParameters&lt;/key&gt;
                &lt;dict&gt;
                    &lt;key&gt;DiffieHellmanGroup&lt;/key&gt;
                    &lt;integer&gt;0&lt;/integer&gt;
                    &lt;key&gt;EncryptionAlgorithm&lt;/key&gt;
                    &lt;string&gt;3DES&lt;/string&gt;
                    &lt;key&gt;IntegrityAlgorithm&lt;/key&gt;
                    &lt;string&gt;SHA1-96&lt;/string&gt;
                    &lt;key&gt;LifeTimeInMinutes&lt;/key&gt;
                    &lt;integer&gt;1440&lt;/integer&gt;
                &lt;/dict&gt;
                &lt;key&gt;LocalIdentifier&lt;/key&gt;
                &lt;string&gt;vpn.googday.club&lt;/string&gt;
                &lt;key&gt;RemoteAddress&lt;/key&gt;
                &lt;string&gt;vpn.googday.club&lt;/string&gt;
                &lt;key&gt;RemoteIdentifier&lt;/key&gt;
                &lt;string&gt;vpn.googday.club&lt;/string&gt;
                &lt;key&gt;SharedSecret&lt;/key&gt;
                &lt;string&gt;googday&lt;/string&gt;


        &lt;!-- 开始按需定制 WiFi连接 --&gt;
                &lt;key&gt;OnDemandEnabled&lt;/key&gt;
                &lt;integer&gt;1&lt;/integer&gt;
                &lt;key&gt;OnDemandRules&lt;/key&gt;
                &lt;array&gt;
            &lt;!-- 这个故意保留，您可以自定在哪些WiFi不必自动连接
            &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;Disconnect&lt;/string&gt;
                        &lt;key&gt;InterfaceTypeMatch&lt;/key&gt;
                        &lt;string&gt;WiFi&lt;/string&gt;
                        &lt;key&gt;SSIDMatch&lt;/key&gt;
                        &lt;array&gt;
                            &lt;string&gt;Coco_baobao-5G&lt;/string&gt;
                        &lt;/array&gt;
          &lt;/dict&gt;
          --&gt;
          &lt;!-- 接下来这部分是规定了在 WiFi下自动连接Ikev2 --&gt;
                    &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;Connect&lt;/string&gt;
                        &lt;key&gt;InterfaceTypeMatch&lt;/key&gt;
                        &lt;string&gt;WiFi&lt;/string&gt;
                    &lt;/dict&gt;
          &lt;!-- 下面的 Cellular则是要求手机在3G/4G下不自动 VPN --&gt;
                    &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;Disconnect&lt;/string&gt;
                        &lt;key&gt;InterfaceTypeMatch&lt;/key&gt;
                        &lt;string&gt;Cellular&lt;/string&gt;
                    &lt;/dict&gt;
                &lt;/array&gt;
        &lt;!--以上就是自动 WiFi连接的设定 --&gt;

            &lt;/dict&gt; &lt;!-- 注意这个dict ，请把代码插入这个中间的位置 --&gt;
            &lt;key&gt;IPv4&lt;/key&gt;
            &lt;dict&gt;
                &lt;key&gt;OverridePrimary&lt;/key&gt;
                &lt;integer&gt;1&lt;/integer&gt;
            &lt;/dict&gt;
            &lt;key&gt;PayloadDescription&lt;/key&gt;
            &lt;string&gt;Configures VPN settings&lt;/string&gt;
            &lt;key&gt;PayloadDisplayName&lt;/key&gt;
            &lt;string&gt;VPN&lt;/string&gt;
</code></pre>

<p>怎么样，其实没有想象中的难吧，这样一来，你就可以将你所买到的 VPN供应商的描述文件自己动手改造一下咯。下面的部分我就不再这样重复了，因为要插入的位置是一样的。</p>

<h1 id="toc_1">按域名自动连接</h1>

<p>按域名的实现，很多前辈在 iOS 7以前的时代就实现过，不过很不幸 iOS 8有一些改变，有些字段不太一样了，所以我才要自己研究一下。不多说，功能就是按照域名列表来实现自动连接。</p>

<pre><code>        
        &lt;!-- 加入自己想要的域名 --&gt;
                &lt;key&gt;OnDemandEnabled&lt;/key&gt;
                &lt;integer&gt;1&lt;/integer&gt;
                &lt;key&gt;OnDemandRules&lt;/key&gt;
                &lt;array&gt;
                &lt;dict&gt;
                        &lt;key&gt;Action&lt;/key&gt;
                        &lt;string&gt;EvaluateConnection&lt;/string&gt;
                        &lt;key&gt;ActionParameters&lt;/key&gt;
              &lt;array&gt;
                &lt;dict&gt;
                                &lt;key&gt;DomainAction&lt;/key&gt;
                                &lt;string&gt;ConnectIfNeeded&lt;/string&gt;
                                &lt;key&gt;Domains&lt;/key&gt;
                                &lt;array&gt;
                    &lt;!-- 加入自己想要的域名 --&gt;
                                    &lt;string&gt;*twitter.com&lt;/string&gt;
                                    &lt;string&gt;*dropbox.com&lt;/string&gt;
                                    &lt;string&gt;*google.com&lt;/string&gt;
                                    &lt;string&gt;*google.co.jp&lt;/string&gt;
                                    &lt;string&gt;*facebook.com&lt;/string&gt;
                                    &lt;string&gt;*youtube.com&lt;/string&gt;
                                    &lt;string&gt;*instagram.com&lt;/string&gt;
                                    &lt;string&gt;t.co&lt;/string&gt;
                                &lt;/array&gt;
              &lt;/dict&gt;
            &lt;/array&gt;
                    &lt;/dict&gt;
                &lt;/array&gt;
</code></pre>

<h1 id="toc_2">长连接</h1>

<p>也有人喜欢让自己的 VPN一直连着，那么只要加入下面这条就直接可以实现了：</p>

<pre><code>        &lt;!-- 开始按需定制 WiFi连接 --&gt;
                &lt;key&gt;OnDemandEnabled&lt;/key&gt;
                &lt;integer&gt;1&lt;/integer&gt;
                &lt;key&gt;OnDemandRules&lt;/key&gt;
                &lt;array&gt;
    &lt;dict&gt;
        &lt;key&gt;Action&lt;/key&gt;
            &lt;string&gt;Connect&lt;/string&gt;
    &lt;/dict&gt; 
    &lt;/arry&gt;

</code></pre>

<h1 id="toc_3">可否将这几种配置合成使用？</h1>

<p>我也是这么想的，不过这涉及很混乱的逻辑以及判断性能，只能说， WiFi自动连接与按域名自动连接目前还没有很好的共存且共同起作用。我还在继续测试，目前我的解决方案就是前面提到的同一个VPN建三份，然后配上不同的配置，根据需要选定其中一个满足不同的人。就我个人来说，我只是使用 WiFi下自动连接 ，记住任何免费WiFi都有可能是蜜罐，用来入侵你的设备。</p>

<p>文章先写到这里。 有空再补充<br/>
<em>完结</em></p>

		</div>
	</article>
	<div class="share-comment">
	
	</div>
</div>        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>




</body>
</html>